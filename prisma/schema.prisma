generator client {
  provider      = "prisma-client-js"
  binaryTargets = ["native", "debian-openssl-1.1.x", "debian-openssl-3.0.x"]
}

datasource db {
  provider = "mongodb"
  url      = env("MONGODB_URI")
}

model Trade {
  id                String   @id @map("_id") @default(auto()) @db.ObjectId
  accountNumber     String
  quantity          Float
  entryId           String?  @default("")
  closeId           String?  @default("")
  instrument        String
  entryPrice        String
  closePrice        String
  entryDate         String
  closeDate         String
  pnl               Float
  timeInPosition    Float    @default(0)
  userId            String   @db.ObjectId
  side              String?  @default("")
  commission        Float    @default(0)
  createdAt         DateTime @default(now())
  comment           String?
  tags              String[] @default([])
  imageBase64       String?
  videoUrl          String?
  imageBase64Second String?
  groupId           String?  @db.ObjectId
  images            String[] @default([])

  @@index([accountNumber])
  @@index([groupId])
}

model TickDetails {
  id        String @id @map("_id") @default(auto()) @db.ObjectId
  ticker    String
  tickValue Float
  tickSize  Float
}

model Subscription {
  id          String    @id @map("_id") @default(auto()) @db.ObjectId
  email       String    @unique
  plan        String
  createdAt   DateTime  @default(now())
  userId      String    @unique @db.ObjectId
  endDate     DateTime?
  status      String    @default("ACTIVE")
  trialEndsAt DateTime?
  interval    String?
  user        User      @relation(fields: [userId], references: [id])

  // email already unique; no extra index needed
}

model BusinessSubscription {
  id          String    @id @map("_id") @default(auto()) @db.ObjectId
  email       String    @unique
  plan        String
  createdAt   DateTime  @default(now())
  userId      String    @unique @db.ObjectId
  user        User      @relation(fields: [userId], references: [id])
  business    Business  @relation(fields: [businessId], references: [id])
  businessId  String    @unique @db.ObjectId
  endDate     DateTime?
  status      String    @default("ACTIVE")
  trialEndsAt DateTime?
  interval    String?

  // indexes implied by unique fields; remove duplicates
}

model Notification {
  id          String    @id @map("_id") @default(auto()) @db.ObjectId
  userId      String    @db.ObjectId
  title       String
  description String
  createdAt   DateTime  @default(now())
  readAt      DateTime?
  user        User      @relation(fields: [userId], references: [id])

  @@index([userId])
}

model User {
  id                    String                 @id @map("_id") @default(auto()) @db.ObjectId
  email                 String                 @unique
  auth_user_id          String                 @unique
  passwordHash          String?
  isFirstConnection     Boolean                @default(true)
  etpToken              String?
  isBeta                Boolean                @default(false)
  language              String                 @default("en")
  openaiApiKey          String?
  thorToken             String?
  createdAt             DateTime               @default(now())
  updatedAt             DateTime               @updatedAt
  accounts              Account[]
  businesses            Business[]
  comments              Comment[]
  dashboardLayout       DashboardLayout?
  groups                Group[]
  moods                 Mood[]
  notifications         Notification[]
  orders                Order[]
  posts                 Post[]
  subscriptions         Subscription?
  synchronizations      Synchronization[]
  tags                  Tag[]
  votes                 Vote[]
  businessSubscriptions BusinessSubscription[]
  referral              Referral?

  // email already unique; no extra index needed
}

model Synchronization {
  id             String    @id @map("_id") @default(auto()) @db.ObjectId
  userId         String    @db.ObjectId
  service        String
  accountId      String
  lastSyncedAt   DateTime
  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @updatedAt
  token          String?
  tokenExpiresAt DateTime?
  dailySyncTime  DateTime?
  user           User      @relation(fields: [userId], references: [id])

  @@unique([userId, service, accountId])
  @@index([userId])
  @@index([service])
}

model Business {
  id                   String                @id @map("_id") @default(auto()) @db.ObjectId
  name                 String
  userId               String                @db.ObjectId
  traderIds            String[]              @default([])
  createdAt            DateTime              @default(now())
  updatedAt            DateTime              @updatedAt
  user                 User                  @relation(fields: [userId], references: [id])
  invitations          BusinessInvitation[]
  managers             BusinessManager[]
  businessSubscription BusinessSubscription?

  @@unique([name, userId])
  @@index([userId])
}

model BusinessManager {
  id         String   @id @map("_id") @default(auto()) @db.ObjectId
  businessId String   @db.ObjectId
  managerId  String
  access     String   @default("viewer")
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt
  business   Business @relation(fields: [businessId], references: [id])

  @@unique([businessId, managerId])
  @@index([businessId])
  @@index([managerId])
}

model BusinessInvitation {
  id         String   @id @map("_id") @default(auto()) @db.ObjectId
  businessId String   @db.ObjectId
  email      String
  invitedBy  String
  status     String   @default("PENDING")
  expiresAt  DateTime
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt
  business   Business @relation(fields: [businessId], references: [id])

  @@unique([businessId, email])
  @@index([businessId])
  // email already unique; no extra index needed
  @@index([status])
}

model Group {
  id        String    @id @map("_id") @default(auto()) @db.ObjectId
  name      String
  userId    String    @db.ObjectId
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  accounts  Account[]
  user      User      @relation(fields: [userId], references: [id])

  @@unique([name, userId])
  @@index([userId])
}

model Account {
  id                      String            @id @map("_id") @default(auto()) @db.ObjectId
  number                  String
  propfirm                String            @default("")
  drawdownThreshold       Float             @default(0)
  profitTarget            Float             @default(0)
  isPerformance           Boolean           @default(false)
  userId                  String            @db.ObjectId
  createdAt               DateTime          @default(now())
  startingBalance         Float             @default(0)
  payoutCount             Int               @default(0)
  trailingDrawdown        Boolean           @default(false)
  trailingStopProfit      Float?
  resetDate               DateTime?
  consistencyPercentage   Float?            @default(30)
  groupId                 String?           @db.ObjectId
  accountSize             String?
  accountSizeName         String?
  activationFees          Float?
  balanceRequired         Float?
  dailyLoss               Float?
  evaluation              Boolean           @default(true)
  isRecursively           String?
  maxFundedAccounts       Int?
  maxPayout               String?
  minDays                 Int?
  minPayout               Float?
  minTradingDaysForPayout Int?
  payoutBonus             Float?
  payoutPolicy            String?
  price                   Float?
  priceWithPromo          Float?
  profitSharing           Float?
  rulesDailyLoss          String?
  tradingNewsAllowed      Boolean           @default(true)
  trailing                String?
  autoRenewal             Boolean           @default(false)
  nextPaymentDate         DateTime?
  paymentFrequency        PaymentFrequency?
  promoPercentage         Float?
  promoType               PromoType?
  renewalNotice           Int?
  minPnlToCountAsDay      Float?
  group                   Group?            @relation(fields: [groupId], references: [id])
  user                    User              @relation(fields: [userId], references: [id])
  payouts                 Payout[]
  buffer                  Float             @default(0)

  @@unique([number, userId])
  @@index([number])
  @@index([groupId])
  @@index([nextPaymentDate])
}

model Payout {
  id            String   @id @map("_id") @default(auto()) @db.ObjectId
  amount        Float
  date          DateTime
  createdAt     DateTime @default(now())
  status        String   @default("PENDING")
  accountNumber String
  accountId     String   @db.ObjectId
  account       Account  @relation(fields: [accountId], references: [id])

  @@index([accountNumber])
}

model DashboardLayout {
  id        String   @id @map("_id") @default(auto()) @db.ObjectId
  userId    String   @unique @db.ObjectId
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  desktop   Json     @default("[]")
  mobile    Json     @default("[]")
  user      User     @relation(fields: [userId], references: [id])
}

model SubscriptionFeedback {
  id                 String   @id @map("_id") @default(auto()) @db.ObjectId
  email              String
  event              String
  createdAt          DateTime @default(now())
  cancellationReason String?
  feedback           String?

  @@index([email])
}

model Mood {
  id                   String   @id @map("_id") @default(auto()) @db.ObjectId
  userId               String   @db.ObjectId
  day                  DateTime
  mood                 String
  conversation         Json?
  createdAt            DateTime @default(now())
  updatedAt            DateTime @updatedAt
  emotionValue         Int      @default(50)
  hasTradingExperience Boolean?
  journalContent       String?
  selectedNews         String[] @default([])
  user                 User     @relation(fields: [userId], references: [id])

  @@unique([userId, day])
  @@index([userId])
  @@index([day])
}

model Shared {
  id             String    @id @map("_id") @default(auto()) @db.ObjectId
  userId         String    @db.ObjectId
  slug           String    @unique
  title          String?
  description    String?
  createdAt      DateTime  @default(now())
  expiresAt      DateTime?
  isPublic       Boolean   @default(true)
  viewCount      Int       @default(0)
  accountNumbers String[]
  dateRange      Json
  desktop        Json      @default("[]")
  mobile         Json      @default("[]")

  @@index([userId])
}

model Referral {
  id              String   @id @map("_id") @default(auto()) @db.ObjectId
  userId          String   @unique @db.ObjectId
  slug            String   @unique
  referredUserIds String[] @default([])
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  user            User     @relation(fields: [userId], references: [id])
}

model FinancialEvent {
  id          String   @id @map("_id") @default(auto()) @db.ObjectId
  title       String
  date        DateTime
  importance  String
  type        String
  description String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  sourceUrl   String?
  country     String?
  lang        String   @default("fr")
  timezone    String   @default("UTC")

  @@unique([title, date, lang, timezone])
  @@index([date])
}

model Tag {
  id          String   @id @map("_id") @default(auto()) @db.ObjectId
  name        String
  description String?
  color       String?  @default("#CBD5E1")
  userId      String   @db.ObjectId
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  user        User     @relation(fields: [userId], references: [id])

  @@unique([name, userId])
  @@index([userId])
}

model Newsletter {
  id        String  @id @map("_id") @default(auto()) @db.ObjectId
  email     String  @unique
  isActive  Boolean @default(true)
  firstName String?
  lastName  String?
}

model Post {
  id          String     @id @map("_id") @default(auto()) @db.ObjectId
  title       String
  content     String
  type        PostType   @default(FEATURE_REQUEST)
  status      PostStatus @default(OPEN)
  userId      String     @db.ObjectId
  createdAt   DateTime   @default(now())
  updatedAt   DateTime   @updatedAt
  screenshots String[]   @default([])
  comments    Comment[]
  user        User       @relation(fields: [userId], references: [id])
  votes       Vote[]

  @@index([userId])
  @@index([type])
  @@index([status])
}

model Comment {
  id        String    @id @map("_id") @default(auto()) @db.ObjectId
  content   String
  postId    String    @db.ObjectId
  userId    String    @db.ObjectId
  parentId  String?   @db.ObjectId
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  parent    Comment?  @relation("CommentReplies", fields: [parentId], references: [id], onDelete: NoAction, onUpdate: NoAction)
  replies   Comment[] @relation("CommentReplies")
  post      Post      @relation(fields: [postId], references: [id])
  user      User      @relation(fields: [userId], references: [id])

  @@index([postId])
  @@index([userId])
  @@index([parentId])
}

model Vote {
  id        String   @id @map("_id") @default(auto()) @db.ObjectId
  type      VoteType
  postId    String   @db.ObjectId
  userId    String   @db.ObjectId
  createdAt DateTime @default(now())
  post      Post     @relation(fields: [postId], references: [id])
  user      User     @relation(fields: [userId], references: [id])

  @@unique([postId, userId])
  @@index([postId])
  @@index([userId])
}

model Order {
  id                 String   @id @map("_id") @default(auto()) @db.ObjectId
  accountId          String   @db.ObjectId
  orderId            String   @unique
  orderAction        String
  quantity           Int
  averageFilledPrice Float
  isOpeningOrder     Boolean
  time               DateTime
  symbol             String
  instrumentType     String
  userId             String   @db.ObjectId
  createdAt          DateTime @default(now())
  user               User     @relation(fields: [userId], references: [id])

  @@index([accountId])
  @@index([userId])
}

model TradeAnalytics {
  id                 String   @id @map("_id") @default(auto()) @db.ObjectId
  tradeId            String   @unique
  mae                Float    @default(0)
  mfe                Float    @default(0)
  entryPriceFromData Float?
  priceDifference    Float?
  riskRewardRatio    Float?
  efficiency         Float?
  dataSource         String   @default("DATABENTO")
  computedAt         DateTime @default(now())
  updatedAt          DateTime @updatedAt

  // tradeId already unique; no extra index needed
  @@index([computedAt])
}

model HistoricalData {
  id             String   @id @map("_id") @default(auto()) @db.ObjectId
  symbol         String
  databentSymbol String
  timestamp      DateTime
  open           Float
  high           Float
  low            Float
  close          Float
  volume         Int
  dataSource     String   @default("DATABENTO")
  createdAt      DateTime @default(now())

  @@unique([symbol, databentSymbol, timestamp])
  @@index([symbol])
  @@index([databentSymbol])
  @@index([timestamp])
}

enum PostType {
  FEATURE_REQUEST
  BUG_REPORT
  DISCUSSION
}

enum PostStatus {
  OPEN
  IN_PROGRESS
  COMPLETED
  CLOSED
}

enum VoteType {
  UPVOTE
  DOWNVOTE
}

enum PaymentFrequency {
  MONTHLY
  QUARTERLY
  BIANNUAL
  ANNUAL
  CUSTOM
}

enum PromoType {
  DIRECT
  PERCENTAGE
}
