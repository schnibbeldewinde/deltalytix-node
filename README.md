# Deltalytix (Mongo/Node Edition)

Modern trading journal and analytics dashboard built with Next.js, MongoDB, Prisma, and Docker. Includes AI-powered analysis, rich importers (MT5 HTML, Sierra Chart, Tradezella-style CSV), customizable widgets, and data-management tools (backup/restore, duplicate handling).

## Stack & Architecture
- **Frontend**: Next.js 16 (App Router), React, TypeScript, Tailwind, Zustand/Context for state.
- **Backend**: Next.js API routes, Prisma (MongoDB connector), custom auth/session handling, data backup/restore & dedupe endpoints.
- **Database**: MongoDB replica set (required by Prisma for transactions) provisioned via Docker.
- **AI**: OpenAI API (key can be stored per user in Settings or via env).
- **Infra**: Docker/Docker Compose (app + Mongo), multi-stage Node 20 build.

## What’s in the app
- Imports: MT5 HTML report, Sierra Chart exports, CSV mapping, Tradezella-style parsing.
- Dashboards: Widgets (Net PnL, Profit Factor, Trade Win %, RR, etc.), Trade View table with column configuration and Exit Date support.
- Data Management: Backup/restore the DB, duplicate detection/removal, export helpers.
- Settings: Theme, timezone, OpenAI key storage (per user) plus build metadata display.

## Prerequisites
- Docker & Docker Compose (recommended)
- Alternatively: Node.js 20+ if running without Docker

## Quick Start (Production, Docker)
1) Copy env file and set your values:
```bash
cp .env.example .env
```
   - `MONGODB_URI` is pre-set for Docker: `mongodb://mongo:27017/deltalytix?replicaSet=rs0`
   - `AUTH_SECRET` must be generated by: `openssl rand -hex 32`
   - `ENCRYPTION_KEY` must be generated by: `openssl rand -hex 32`
   - Optional: `OPENAI_API_KEY` (or set per user in Settings UI)
   - Optional: `NEXT_PUBLIC_BUILD_NUMBER`, `NEXT_PUBLIC_BUILD_DATE`
2) Build & run: (Open Terminal)
```bash
docker compose up --build
```
3) App: http://localhost:3000

## Dev Mode (Docker)
Live-reload with mounted source:
```bash
docker compose -f docker-compose.dev.yml up --build
```
- Uses `npm run dev`
- Mounts repo into the container; persists Mongo via `mongo-data` volume

## Run without Docker (local Node)
1) Copy env (defaults to the Docker hostname `mongo`). If you run the app on the host while reusing the Docker Mongo, add a hosts entry (`127.0.0.1 mongo`) so the name resolves locally. If you instead run your own local Mongo, override `MONGODB_URI` to point at it:
```bash
cp .env.example .env
# For local Mongo instead of Docker:
# export MONGODB_URI="mongodb://localhost:27017/deltalytix?replicaSet=rs0"
```
2) Install deps & generate Prisma client:
```bash
npm install
npx prisma generate
```
3) Start dev server:
```bash
npm run dev
```

## Access in the browser
- Default local URL: http://localhost:3000
- Auth/Settings/Dashboard follow the locale path (e.g. `http://localhost:3000/en/dashboard`)
- Ensure Mongo is running (via Compose or your own instance) and `MONGODB_URI` is set.

## Optional: Expose via Cloudflared (HTTPS tunnel)
You can publish the app through a Cloudflare Tunnel without opening inbound ports. Add a `cloudflared` service to your Compose and supply your tunnel credentials:

```yaml
# docker-compose.cloudflared.yml (example)
version: "3.9"

services:
  cloudflared:
    image: cloudflare/cloudflared:latest
    command: tunnel run
    environment:
      TUNNEL_TOKEN: ${CLOUDFLARE_TUNNEL_TOKEN}
    restart: unless-stopped

  # include the existing services (app, mongo, mongo-init-replica)
  # or extend your main docker-compose.yml with `-f` flag.
```

Steps:
1. Create a tunnel in your Cloudflare dashboard and note the `TUNNEL_TOKEN`.
2. Export or add `CLOUDFLARE_TUNNEL_TOKEN` to your `.env`.
3. Run with an extra compose file, e.g.:
   ```bash
   docker compose -f docker-compose.yml -f docker-compose.cloudflared.yml up -d
   ```
4. In Cloudflare, map your tunnel to your domain and point it to the `app` service (`http://app:3000` inside the Compose network).

## Environment Variables (key ones)
- `MONGODB_URI` – Mongo replica set connection string
- `OPENAI_API_KEY` – (optional) global key; per-user key can be saved in Settings
- `NEXT_PUBLIC_BUILD_NUMBER`, `NEXT_PUBLIC_BUILD_DATE` – build metadata shown in Settings
- `NEXT_PUBLIC_APP_URL` – public app URL (optional)
- `AUTH_SECRET` – random secret for NextAuth/session usage. Generate via `openssl rand -base64 32` or `node -e "console.log(require('crypto').randomBytes(32).toString('base64'))"`.
- `ENCRYPTION_KEY` – random 32-byte key (Base64) for local encryption. Generate via `openssl rand -base64 32` or the same Node one-liner above.

If Compose did not inject them for you, set them manually in `.env` or via Compose env vars.

## Project Structure (high level)
- `app/api/ai/**` – AI endpoints (analysis, chat, mappings, format-trades) using OpenAI
- `app/api/import/**` – Import pipelines and helpers
- `app/api/backup` / `app/api/dedupe` – Data backup/restore and duplicate handling
- `app/[locale]/dashboard/**` – UI (widgets, Trade View, Analysis, Settings)
- `components/**` – Shared UI elements (tables, cards, dialogs)
- `prisma/schema.prisma` – MongoDB schema (Prisma)
- `docker-compose.yml` / `docker-compose.dev.yml` – App + Mongo services

## OpenAI Key Usage
- NOT-Preferred: Store per user in **Settings → OpenAI API Key** (plaintext for verification) 
- Alternative: Set `OPENAI_API_KEY` in `.env` / compose env

## Common Commands
- Prod build locally: `npm run build && npm run start`
- Prisma client: `npx prisma generate`
- Dev (Node): `npm run dev`
- Docker prod: `docker compose up --build`
- Docker dev: `docker compose -f docker-compose.dev.yml up --build`

## Notes
- Mongo runs as a single-node replica set (`rs0`) for Prisma transactions.
- Data persists in `mongo-data` volume in Compose.
- For AI features, ensure an OpenAI key is provided (env or Settings). If quota is exceeded, OpenAI will return `insufficient_quota` errors.

## License
This project is provided for self-hosted use. Review included assets and third-party licenses as applicable.
